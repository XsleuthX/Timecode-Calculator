<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timecode Calculator — Paste & Parse (v4 – Unicode-safe)</title>
<style>
  :root{
    --bg:#0e1116; --panel:#141922; --text:#e9f0ff; --muted:#96a0b5;
    --accent:#7aa2ff; --good:#39d98a; --warn:#ffb155; --bad:#ff6b6b; --border:#253043;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:18px 20px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#0f131a,#0b0e13)}
  h1{margin:0;font-size:18px;letter-spacing:.3px}
  main{padding:16px;max-width:1100px;margin:0 auto}
  .row{display:grid;grid-template-columns: 1fr; gap:12px; margin-bottom:12px}
  @media (min-width: 900px){ .row{grid-template-columns: 1.2fr .8fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  textarea{width:100%;min-height:260px;background:#0b0f16;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:12px;resize:vertical;outline:none}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0f1520;color:var(--text);cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#233250,#1a2740);border-color:#2b3b5b}
  table{width:100%;border-collapse:collapse;font-variant-numeric: tabular-nums}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{color:#b9c6e1;text-align:left;position:sticky;top:0;background:var(--panel);z-index:1}
  tbody tr:hover{background:#0f1520}
  .right{text-align:right}.nowrap{white-space:nowrap}.small{font-size:12px}
  .kpi{display:grid;grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:10px}
  .tile{background:#0b0f16;border:1px solid var(--border);border-radius:10px;padding:10px}
  .tile h3{margin:0 0 4px 0;font-size:12px;color:var(--muted);font-weight:500}
  .tile .val{font-size:18px}
  .err{ color:var(--bad) }
  .hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header><h1>Timecode Calculator — paste from Google Doc</h1></header>
<main>
  <div class="row">
    <div class="card">
      <label for="input" class="small">Paste your script (with timecodes) here</label>
      <textarea id="input" placeholder="e.g.
00:08:02:05 – 00:08:04:24
00:08:04:24 - 00:08:07:23"></textarea>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
        <button class="btn primary" id="btnParse">Calculate</button>
        <button class="btn" id="btnSample">Load sample</button>
        <button class="btn" id="btnClear">Clear</button>
        <span id="debug" class="hint"></span>
      </div>
    </div>
    <div class="card">
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px">
        <div>
          <label for="fps" class="small">Frame rate (for HH:MM:SS:FF)</label>
          <select id="fps">
            <option value="23.976">23.976</option><option value="24">24</option>
            <option value="25" selected>25</option><option value="29.97">29.97</option>
            <option value="30">30</option><option value="50">50</option>
            <option value="59.94">59.94</option><option value="60">60</option>
          </select>
        </div>
        <div>
          <label for="pairing" class="small">Pairing mode</label>
          <select id="pairing">
            <option value="line" selected>Pair within each line</option>
            <option value="global">Pair consecutively (global)</option>
          </select>
        </div>
      </div>
      <div class="kpi">
        <div class="tile"><h3>Total clips</h3><div class="val" id="kClips">0</div></div>
        <div class="tile"><h3>Total duration</h3><div class="val" id="kDur">00:00:00.000</div></div>
        <div class="tile"><h3>Total frames (@<span id="kFps">25</span> fps)</h3><div class="val" id="kFrames">0</div></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button class="btn" id="btnCSV">Export Table as CSV</button>
        <button class="btn" id="btnCopy">Copy Summary</button>
      </div>
    </div>
  </div>

  <div class="card">
    <table id="results">
      <thead><tr><th>#</th><th>Context</th><th>In</th><th>Out</th><th>Duration</th><th class="right">Frames</th><th class="right">Line</th></tr></thead>
      <tbody></tbody>
    </table>
    <div id="errors" class="small err" style="margin-top:8px"></div>
  </div>
</main>

<script>
(function(){
  // Regex literal for ASCII digits/colons (works after normalization)
  const RE = /\b(\d{1,2}):([0-5]\d):([0-5]\d)(?:([:.])(\d{1,3}))?\b/g; // escaped in HTML string

  const el = {
    input: document.getElementById('input'),
    fps: document.getElementById('fps'),
    pairing: document.getElementById('pairing'),
    btnParse: document.getElementById('btnParse'),
    btnSample: document.getElementById('btnSample'),
    btnClear: document.getElementById('btnClear'),
    btnCSV: document.getElementById('btnCSV'),
    btnCopy: document.getElementById('btnCopy'),
    kClips: document.getElementById('kClips'),
    kDur: document.getElementById('kDur'),
    kFrames: document.getElementById('kFrames'),
    kFps: document.getElementById('kFps'),
    tableBody: document.querySelector('#results tbody'),
    errors: document.getElementById('errors'),
    debug: document.getElementById('debug'),
  };

  function clean(text){
    // Normalize full-width digits/colons etc. and strip zero-width chars
    return (text || '')
      .replace(/[\u200B\u200C\u200D\uFEFF]/g,'')
      .normalize('NFKC');
  }

  function msToHMS(ms){
    const sign = ms < 0 ? '-' : '';
    ms = Math.abs(ms);
    const h = Math.floor(ms/3600000); ms %= 3600000;
    const m = Math.floor(ms/60000); ms %= 60000;
    const s = Math.floor(ms/1000);
    const msr = Math.floor(ms % 1000);
    return sign + String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') + '.' + String(msr).padStart(3,'0');
  }

  function parseTC(match){
    const [full, h, m, s, sep, sub] = match;
    const HH = parseInt(h,10), MM = parseInt(m,10), SS = parseInt(s,10);
    let ms = (HH*3600 + MM*60 + SS)*1000;
    if (sep === '.'){
      let fract = String(sub||'').padEnd(3,'0').slice(0,3);
      ms += parseInt(fract,10);
    } else if (sep === ':'){
      const fps = parseFloat(el.fps.value);
      const FF = parseInt(sub||'0',10);
      const frameMs = Math.round(1000*(FF/fps));
      ms += frameMs;
    }
    return { text: full, ms, sep, sub };
  }

  function findTimecodesInLine(line){
    const result = [];
    let m;
    RE.lastIndex = 0;
    while ((m = RE.exec(line))){
      result.push(parseTC(m));
    }
    return result;
  }

  function summarize(text, maxLen=80){
    if (!text) return '';
    const t = text.replace(/\s+/g,' ').trim();
    return t.length > maxLen ? t.slice(0,maxLen-1)+'…' : t;
  }

  function pairTimecodes(lines, mode){
    const pairs = [];
    const issues = [];
    if (mode === 'line'){
      lines.forEach((line, idx)=>{
        const tcs = findTimecodesInLine(line);
        if (tcs.length === 1){
          issues.push(`Line ${idx+1}: only one timecode found; skipped.`);
        }
        for (let i=0;i<tcs.length-1;i+=2){
          const a = tcs[i], b = tcs[i+1];
          pairs.push({ in:a, out:b, line: idx+1, context: line });
        }
      });
    } else {
      const all = [];
      lines.forEach((line, idx)=>{
        findTimecodesInLine(line).forEach(tc=> all.push({tc, idx, line}));
      });
      if (all.length % 2 === 1){
        issues.push(`Odd number of timecodes (${all.length}) found; the last one is dropped.`);
      }
      for (let i=0;i<all.length-1;i+=2){
        const a = all[i], b = all[i+1];
        pairs.push({ in:a.tc, out:b.tc, line: b.idx+1, context: b.line });
      }
    }
    return { pairs, issues };
  }

  function durationFrames(ms){
    const fps = parseFloat(el.fps.value);
    return Math.round(ms * fps / 1000);
  }

  function compute(){
    let raw = el.input.value || '';
    const text = clean(raw);
    // Count matches on normalized text
    let count=0; RE.lastIndex=0; while(RE.exec(text)) count++;
    el.debug.textContent = `Found ${count} timecodes`;
    const lines = text.split(/\r?\n/);

    const { pairs, issues } = pairTimecodes(lines, el.pairing.value);

    el.tableBody.innerHTML = '';
    el.errors.textContent = issues.join(' ');
    el.kFps.textContent = el.fps.value;

    let totalMs = 0;
    let totalFrames = 0;
    let clipIdx = 0;
    const rowsForCsv = [];

    for (const p of pairs){
      const dur = p.out.ms - p.in.ms;
      clipIdx++;
      const preferFramesIn = (p.in.sep === ':');
      const preferFramesOut = (p.out.sep === ':');

      const tr = document.createElement('tr');
      const ctx = summarize(p.context);

      const cells = [
        String(clipIdx),
        ctx || '',
        preferFramesIn ? p.in.text : msToHMS(p.in.ms),
        preferFramesOut ? p.out.text : msToHMS(p.out.ms),
        msToHMS(dur),
        String(durationFrames(dur)),
        String(p.line)
      ];
      cells.forEach((c, i)=>{
        const td = document.createElement('td');
        td.textContent = c;
        if (i===5 || i===6) td.className = 'right nowrap';
        tr.appendChild(td);
      });
      if (dur <= 0) tr.style.color = 'var(--warn)';
      el.tableBody.appendChild(tr);

      if (dur > 0){
        totalMs += dur;
        totalFrames += durationFrames(dur);
      }
      rowsForCsv.push(cells);
    }

    el.kClips.textContent = String(pairs.length);
    el.kDur.textContent = msToHMS(totalMs);
    el.kFrames.textContent = String(totalFrames);

    el.btnCSV.onclick = () => {
      const header = ['#','Context','In','Out','Duration','Frames','Line'];
      const csv = [header].concat(rowsForCsv).map(r=>r.map(v=>{
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'timecode_durations.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    el.btnCopy.onclick = () => {
      const summary = `Clips: ${pairs.length}\nTotal: ${msToHMS(totalMs)}\nFrames(@${el.fps.value}): ${totalFrames}`;
      navigator.clipboard.writeText(summary).then(()=>{
        el.errors.textContent = 'Copied summary to clipboard.';
        setTimeout(()=> el.errors.textContent = issues.join(' '), 1200);
      }).catch(()=>{
        el.errors.textContent = 'Unable to access clipboard.';
      });
    };
  }

  el.btnParse.addEventListener('click', compute);
  el.fps.addEventListener('change', compute);
  el.pairing.addEventListener('change', compute);
  el.btnClear.addEventListener('click', ()=>{ el.input.value=''; el.tableBody.innerHTML=''; el.kClips.textContent='0'; el.kDur.textContent='00:00:00.000'; el.kFrames.textContent='0'; el.errors.textContent=''; el.debug.textContent=''; });
  el.btnSample.addEventListener('click', ()=>{
    el.input.value = `Interview 罗盖文 Annabel Law
C0623.mp4

00:08:02:05 – 00:08:04:24
00:08:04:24 - 00:08:07:23

00:08:12:19 - 00:08:23:14


00:08:30:03 – 00:08:34:09

00:08:38:04 - 00:08:40:20`;
  });

  el.input.addEventListener('paste', () => setTimeout(compute, 10));
})();
</script>
</body>
</html>
